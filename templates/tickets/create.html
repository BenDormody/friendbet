{% extends "base.html" %}

{% block title %}Create Ticket - {{ league.name }}{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-9">
      <div class="card mb-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h2 class="mb-0">Create Ticket</h2>
          <a href="{{ url_for('leagues.detail', league_id=league._id) }}" class="btn btn-ghost">
            <i data-lucide="arrow-left" class="me-2"></i>
            Back to League
          </a>
        </div>
        <p class="text-secondary mb-4">Create a new betting ticket for {{ league.name }}.</p>

        <form method="POST" novalidate id="ticket-form">
          {{ form.hidden_tag() }}

          <div class="mb-3">
            <label class="form-label" for="title">{{ form.title.label.text }}</label>
            {{ form.title(class_='form-control', id='title', placeholder='e.g., Super Bowl Winner') }}
            {% for error in form.title.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="description">{{ form.description.label.text }}</label>
            {{ form.description(class_='form-control', id='description', rows='4', placeholder='Optional description of the bet') }}
            {% for error in form.description.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label class="form-label" for="ticket_type">{{ form.ticket_type.label.text }}</label>
              {{ form.ticket_type(class_='form-select', id='ticket_type') }}
            </div>
            <div class="col-md-8">
              <label class="form-label" for="closes_at">{{ form.closes_at.label.text }}</label>
              {{ form.closes_at(class_='form-control', id='closes_at', type='datetime-local') }}
            </div>
          </div>

          <div id="moneyline-fields" class="mt-4">
            <h5 class="mb-3">Moneyline Options</h5>
            <div class="row g-3">
              {% for option_form in form.options %}
                <div class="col-md-8">
                  <label class="form-label">Option {{ loop.index }}</label>
                  {{ option_form.option_text(class_='form-control', placeholder='Team or outcome name') }}
                </div>
                <div class="col-md-4">
                  <label class="form-label">Odds</label>
                  {{ option_form.odds(class_='form-control', placeholder='e.g., 1.8') }}
                </div>
              {% endfor %}
            </div>
            <small class="text-secondary d-block mt-2">At least two options are required.</small>
          </div>

          <div id="overunder-fields" class="mt-4" style="display:none">
            <h5 class="mb-3">Over/Under Settings</h5>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label" for="target_value">{{ form.target_value.label.text }}</label>
                {{ form.target_value(class_='form-control', id='target_value', placeholder='e.g., 47.5') }}
              </div>
              <div class="col-md-4">
                <label class="form-label" for="over_odds">{{ form.over_odds.label.text }}</label>
                {{ form.over_odds(class_='form-control', id='over_odds', placeholder='e.g., 1.9') }}
              </div>
              <div class="col-md-4">
                <label class="form-label" for="under_odds">{{ form.under_odds.label.text }}</label>
                {{ form.under_odds(class_='form-control', id='under_odds', placeholder='e.g., 1.9') }}
              </div>
            </div>
          </div>

          <div class="d-flex align-items-center gap-3 mt-4">
            {{ form.submit(class_='btn btn-primary') }}
            <button type="button" class="btn btn-secondary" id="toggle-type">Toggle Type</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h4 class="mb-2">Guidelines</h4>
        <ul class="mb-0">
          <li>Moneyline: Add at least two options with decimal odds.</li>
          <li>Over/Under: Provide a target value and odds for both sides.</li>
          <li>Closes At: After this time, no more bets can be placed.</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function(){
    const typeSelect = document.getElementById('ticket_type');
    const moneyline = document.getElementById('moneyline-fields');
    const overunder = document.getElementById('overunder-fields');
    const toggleBtn = document.getElementById('toggle-type');

    function updateVisibility() {
      const type = typeSelect.value;
      if (type === 'over_under') {
        moneyline.style.display = 'none';
        overunder.style.display = '';
      } else {
        moneyline.style.display = '';
        overunder.style.display = 'none';
      }
    }

    if (typeSelect) {
      typeSelect.addEventListener('change', updateVisibility);
      updateVisibility();
    }

    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        typeSelect.value = typeSelect.value === 'moneyline' ? 'over_under' : 'moneyline';
        updateVisibility();
      });
    }
  })();
</script>
{% endblock %}
